generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// USER MODEL (Andrew, Jared, Reps)
// ============================================
enum UserRole {
  ADMIN
  REP
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model User {
  id            String     @id @default(cuid())
  email         String     @unique
  passwordHash  String?
  name          String
  role          UserRole   @default(REP)
  phone     String?
  status    UserStatus @default(ACTIVE)
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")
  lastSeenAt DateTime?  @map("last_seen_at")

  // Rep portal fields
  portalType     String  @default("FULL")
  dailyLeadCap   Int     @default(25)
  totalCloses    Int     @default(0)
  commissionRate Float   @default(0.5) @map("commission_rate")

  // Relations
  assignedLeads      Lead[]              @relation("AssignedLeads")
  activities         Activity[]
  commissions        Commission[]
  messages           Message[]
  clawdbotActivities ClawdbotActivity[]
  outboundEvents     OutboundEvent[]     @relation("RepOutboundEvents")
  channelPerformance ChannelPerformance[]
  repTasks           RepTask[]           @relation("RepTasks")
  calls              Call[]              @relation("RepCalls")
  callScorings       CallScoring[]       @relation("RepScoring")
  dialerSessions     DialerSession[]     @relation("DialerSessions")
  clientsAsRep       Client[]            @relation("ClientRep")
  closeEngineConversations CloseEngineConversation[] @relation("CloseEngineRep")

  @@map("users")
}

// ============================================
// LEAD FOLDER MODEL (Organize leads into folders)
// ============================================
model LeadFolder {
  id        String   @id @default(cuid())
  name      String
  color     String   @default("#3B82F6") // Default blue
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  leads Lead[]

  @@map("lead_folders")
}

// ============================================
// LEAD MODEL (Pre-payment prospects)
// ============================================
enum LeadStatus {
  NEW
  HOT_LEAD
  QUALIFIED
  INFO_COLLECTED
  BUILDING
  QA
  CLIENT_REVIEW
  APPROVED
  PAID
  CLOSED_LOST
  DO_NOT_CONTACT
}

enum LeadSource {
  COLD_EMAIL
  COLD_CALL
  META_AD
  REFERRAL
  PARTNER
  ORGANIC
  CSV_IMPORT
  MANUAL
}

enum LeadPriority {
  HOT
  WARM
  COLD
}

model Lead {
  id               String       @id @default(cuid())
  firstName        String       @map("first_name")
  lastName         String?      @map("last_name")
  email            String?
  phone            String
  companyName      String       @map("company_name")
  industry         String       @default("GENERAL_CONTRACTING") // Accept any industry as string
  city             String?
  state            String?
  timezone         String?      @default("America/New_York")
  website          String?
  status           LeadStatus   @default(NEW)
  priority         LeadPriority @default(COLD)
  assignedToId     String?      @map("assigned_to_id")
  folderId         String?      @map("folder_id")
  source           LeadSource
  sourceDetail     String?      @map("source_detail") // Rep name, campaign name, ad variant
  campaign         String?
  previewId        String?      @unique @map("preview_id")
  previewUrl       String?      @map("preview_url")
  previewExpiresAt DateTime?    @map("preview_expires_at")
  personalization  String?      @db.Text // AI-generated first line
  
  // Enriched data from SerpAPI
  enrichedAddress  String?      @map("enriched_address")
  enrichedHours    Json?        @map("enriched_hours")
  enrichedServices Json?        @map("enriched_services") // Array of services
  enrichedRating   Float?       @map("enriched_rating")
  enrichedReviews  Int?         @map("enriched_reviews")
  enrichedPhotos   Json?        @map("enriched_photos") // Array of photo URLs
  
  // Client-provided data
  logo             String?
  photos           Json?        // Array of uploaded photo URLs
  services         Json?        // Client's service list
  hours            Json?        // Business hours
  colorPrefs       Json?        @map("color_prefs")
  
  notes            String?      @db.Text
  callScript       String?      @db.Text @map("call_script")
  churnRiskScore   Int          @default(0) @map("churn_risk_score")
  
  // Close Engine fields
  autonomyLevel     String   @default("FULL_AUTO") @map("autonomy_level") // FULL_AUTO, SEMI_AUTO, MANUAL
  closeEntryPoint   String?  @map("close_entry_point")  // INSTANTLY_REPLY, SMS_REPLY, REP_CLOSE, PREVIEW_CTA
  qualificationData Json?    @map("qualification_data") // Structured data collected by Claude

  // Instantly integration fields
  instantlyStatus  String?      @map("instantly_status") // QUEUED, IN_SEQUENCE, COMPLETED, REPLIED, BOUNCED, UNSUBSCRIBED, PAUSED
  instantlyAddedDate DateTime?  @map("instantly_added_date") // When lead was pushed to Instantly
  instantlyCurrentStep Int      @default(0) @map("instantly_current_step") // Which email step they're on (0-4)
  instantlyCampaignId String?   @map("instantly_campaign_id") // Link to Instantly campaign
  replySentiment   String?      @map("reply_sentiment") // positive, negative, question, neutral
  
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  // Relations
  assignedTo         User?               @relation("AssignedLeads", fields: [assignedToId], references: [id])
  folder             LeadFolder?         @relation(fields: [folderId], references: [id])
  activities         Activity[]
  events             LeadEvent[]
  messages           Message[]
  client             Client?             // One-to-one after payment
  clawdbotActivities ClawdbotActivity[]
  outboundEvents     OutboundEvent[]
  touchRecommendations TouchRecommendation[]
  repTasks           RepTask[]
  calls              Call[]
  closeConversation  CloseEngineConversation?
  pendingActions     PendingAction[]

  @@index([status])
  @@index([assignedToId])
  @@index([folderId])
  @@index([industry])
  @@index([phone])
  @@index([email])
  @@index([previewId])
  @@index([createdAt])
  @@index([instantlyCampaignId])
  @@index([instantlyStatus])
  @@index([instantlyCampaignId, instantlyStatus])
  @@index([instantlyCampaignId, replySentiment])
  @@index([personalization])
  @@index([previewUrl])
  @@map("leads")
}

// ============================================
// LEAD EVENT MODEL (Activity timeline)
// ============================================
enum EventType {
  STAGE_CHANGE
  EMAIL_SENT
  EMAIL_OPENED
  EMAIL_REPLIED
  PREVIEW_VIEWED
  PREVIEW_CTA_CLICKED
  PREVIEW_CALL_CLICKED
  PREVIEW_RETURN_VISIT
  CALL_MADE
  TEXT_SENT
  TEXT_RECEIVED
  INFO_RECEIVED
  PAYMENT_RECEIVED
  SITE_LIVE
  ESCALATED
  CLOSE_ENGINE_TRIGGERED
  CLOSE_ENGINE_STAGE_CHANGE
  CLOSE_ENGINE_COMPLETED
  POSITIVE_FEEDBACK
  SMS_FALLBACK_EMAIL
}

model LeadEvent {
  id         String    @id @default(cuid())
  leadId     String    @map("lead_id")
  eventType  EventType @map("event_type")
  fromStage  String?   @map("from_stage")
  toStage    String?   @map("to_stage")
  metadata   Json?     // Flexible data per event type
  actor      String?   // 'system', 'andrew', 'clawdbot', 'rep:name', 'client'
  createdAt  DateTime  @default(now()) @map("created_at")

  // Relations
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([eventType])
  @@index([createdAt])
  @@map("lead_events")
}

// ============================================
// CLIENT MODEL (Post-payment)
// ============================================
enum HostingStatus {
  ACTIVE
  DEACTIVATED
  CANCELLED
  FAILED_PAYMENT
  GRACE_PERIOD
}

model Client {
  id                   String        @id @default(cuid())
  leadId               String?       @unique @map("lead_id")
  repId                String?       @map("rep_id")
  companyName          String        @map("company_name")
  contactName          String?       @map("contact_name")
  phone                String?
  email                String?
  industry             String        @default("GENERAL_CONTRACTING")
  location             String?
  siteUrl              String?       @map("site_url")
  stagingUrl           String?       @map("staging_url")
  domainStatus         String?       @map("domain_status") // 'none', 'client_owned', 'registered_by_us'
  hostingStatus        HostingStatus @default(ACTIVE)

  // Stripe data
  stripeCustomerId     String?       @unique @map("stripe_customer_id")
  stripeSubscriptionId String?       @unique @map("stripe_subscription_id")

  // Revenue tracking
  monthlyRevenue       Float         @default(39) @map("monthly_revenue")
  plan                 String        @default("base") // base, seo, ads, premium
  upsells              Json?         // Array of active upsell products with prices

  // Health & engagement
  healthScore          Int           @default(50) @map("health_score")
  aiAutoRespond        Boolean       @default(true) @map("ai_auto_respond")
  statReportFrequency  String        @default("monthly") @map("stat_report_frequency")
  referralCode         String?       @unique @map("referral_code")
  tags                 String[]      @default([])
  notes                String?       @db.Text

  // Close Engine fields
  autonomyLevel        String        @default("FULL_AUTO") @map("autonomy_level") // FULL_AUTO, SEMI_AUTO, MANUAL

  // Channel routing
  channelPreference    String?       @map("channel_preference") // SMS, EMAIL, or null (no preference)

  // Lifecycle
  siteLiveDate         DateTime?     @map("site_live_date")
  lastInteraction      DateTime?     @map("last_interaction")
  nextTouchpoint       String?       @map("next_touchpoint")
  nextTouchpointDate   DateTime?     @map("next_touchpoint_date")
  churnRiskScore       Int           @default(0) @map("churn_risk_score")
  closedDate           DateTime?     @map("closed_date")
  churnedDate          DateTime?     @map("churned_date")

  deletedAt            DateTime?     @map("deleted_at")
  createdAt            DateTime      @default(now()) @map("created_at")
  updatedAt            DateTime      @updatedAt @map("updated_at")

  // Relations
  lead               Lead?               @relation(fields: [leadId], references: [id], onDelete: Cascade)
  rep                User?               @relation("ClientRep", fields: [repId], references: [id])
  messages           Message[]
  commissions        Commission[]
  revenue            Revenue[]
  analytics          ClientAnalytics?
  clawdbotActivities ClawdbotActivity[]
  editRequests       EditRequest[]
  sequenceProgress   SequenceProgress[]
  referralsGiven     Referral[]          @relation("ReferrerClient")
  siteAnalytics      SiteAnalytic[]

  @@index([hostingStatus])
  @@index([churnRiskScore])
  @@index([healthScore])
  @@index([nextTouchpointDate])
  @@map("clients")
}

// ============================================
// CLIENT ANALYTICS MODEL
// ============================================
model ClientAnalytics {
  id                String   @id @default(cuid())
  clientId          String   @unique @map("client_id")
  
  // Traffic
  totalVisits       Int      @default(0) @map("total_visits")
  uniqueVisitors    Int      @default(0) @map("unique_visitors")
  
  // Conversions
  totalForms        Int      @default(0) @map("total_forms")
  totalCalls        Int      @default(0) @map("total_calls")
  
  // Engagement
  avgTimeOnSite     Float?   @map("avg_time_on_site")
  bounceRate        Float?   @map("bounce_rate")
  topTrafficSource  String?  @map("top_traffic_source")
  
  // Lead response (for upsell triggers)
  avgResponseTime   Int?     @map("avg_response_time") // In minutes
  missedCalls       Int      @default(0) @map("missed_calls")
  
  // Last updated
  lastCalculated    DateTime @default(now()) @map("last_calculated")
  
  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("client_analytics")
}

// ============================================
// MESSAGE MODEL (All SMS communication)
// ============================================
enum MessageDirection {
  OUTBOUND
  INBOUND
}

enum MessageChannel {
  SMS
  EMAIL
}

model Message {
  id              String           @id @default(cuid())
  leadId          String?          @map("lead_id")
  clientId        String?          @map("client_id")
  direction       MessageDirection
  channel         MessageChannel   @default(SMS)
  senderType      String           @default("SYSTEM") @map("sender_type") // SYSTEM, ADMIN, REP, AI, LEAD, CLIENT
  senderName      String           @default("clawdbot") @map("sender_name")
  senderId        String?          @map("sender_id")
  recipient       String?          // Phone or email
  content         String           @db.Text
  trigger         String?          // 'qualification', 'nudge', 'sequence_day_7', etc.
  escalated       Boolean          @default(false)
  escalationReason String?         @map("escalation_reason")
  conversationType String?         @map("conversation_type") // pre_client, post_client
  aiDelaySeconds  Int?             @map("ai_delay_seconds") // humanizing delay used
  aiGenerated     Boolean          @default(false) @map("ai_generated")
  aiDecisionLog   Json?            @map("ai_decision_log")

  // Twilio data
  twilioSid  String?          @unique @map("twilio_sid")
  twilioStatus String?        @map("twilio_status")

  // Resend data
  resendId     String?        @unique @map("resend_id")
  resendStatus String?        @map("resend_status")
  emailSubject String?        @map("email_subject")

  createdAt  DateTime         @default(now()) @map("created_at")

  // Relations
  lead     Lead?   @relation(fields: [leadId], references: [id], onDelete: Cascade)
  client   Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)
  sentBy   User?   @relation(fields: [senderId], references: [id])

  @@index([leadId])
  @@index([clientId])
  @@index([createdAt])
  @@index([escalated])
  @@index([conversationType])
  @@map("messages")
}

// ============================================
// ACTIVITY MODEL (Rep actions)
// ============================================
enum ActivityType {
  CALL
  VOICEMAIL
  EMAIL
  NOTE
  STATUS_CHANGE
  PREVIEW_SENT
}

enum CallDisposition {
  CONNECTED
  NO_ANSWER
  VOICEMAIL
  WRONG_NUMBER
  GATEKEEPER
  NOT_INTERESTED
  CALLBACK
  INTERESTED
}

model Activity {
  id              String           @id @default(cuid())
  leadId          String           @map("lead_id")
  repId           String           @map("rep_id")
  activityType    ActivityType     @map("activity_type")
  callDisposition CallDisposition? @map("call_disposition")
  durationSeconds Int?             @map("duration_seconds")
  notes           String?          @db.Text
  callbackDate    DateTime?        @map("callback_date")
  createdAt       DateTime         @default(now()) @map("created_at")

  // Relations
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  rep  User @relation(fields: [repId], references: [id])

  @@index([leadId])
  @@index([repId])
  @@index([createdAt])
  @@map("activities")
}

// ============================================
// REP ACTIVITY MODEL (Daily tracking)
// ============================================
model RepActivity {
  id               String   @id @default(cuid())
  repId            String   @map("rep_id")
  date             DateTime @db.Date
  dials            Int      @default(0)
  conversations    Int      @default(0)
  previewLinksSent Int      @default(0) @map("preview_links_sent")
  previewsOpened   Int      @default(0) @map("previews_opened")
  paymentLinksSent Int      @default(0) @map("payment_links_sent")
  paymentsClosed   Int      @default(0) @map("payments_closed")
  closes           Int      @default(0)
  commissionEarned Float    @default(0) @map("commission_earned")
  notes            String?  @db.Text

  @@unique([repId, date])
  @@index([repId])
  @@index([date])
  @@map("rep_activity")
}

// ============================================
// COMMISSION MODEL
// ============================================
enum CommissionType {
  SITE_BUILD
  MONTHLY_RESIDUAL
  BONUS
}

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
  REJECTED
}

model Commission {
  id        String           @id @default(cuid())
  repId     String           @map("rep_id")
  clientId  String           @map("client_id")
  type      CommissionType
  amount    Float
  status    CommissionStatus @default(PENDING)
  period    String?          // For residuals: "2026-02"
  notes     String?
  createdAt DateTime         @default(now()) @map("created_at")
  paidAt    DateTime?        @map("paid_at")

  // Relations
  rep    User   @relation(fields: [repId], references: [id])
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([repId])
  @@index([status])
  @@index([createdAt])
  @@map("commissions")
}

// ============================================
// REVENUE MODEL (All payments)
// ============================================
enum RevenueType {
  SITE_BUILD
  HOSTING_MONTHLY
  HOSTING_ANNUAL
  UPSELL
  ADD_ON
}

enum PaymentStatus {
  PAID
  FAILED
  REFUNDED
  PENDING
}

model Revenue {
  id               String        @id @default(cuid())
  clientId         String        @map("client_id")
  type             RevenueType
  product          String?       // Specific product name
  amount           Float
  recurring        Boolean       @default(false)
  stripePaymentId  String?       @unique @map("stripe_payment_id")
  status           PaymentStatus @default(PENDING)
  createdAt        DateTime      @default(now()) @map("created_at")

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([type])
  @@index([createdAt])
  @@map("revenue")
}

// ============================================
// NOTIFICATION MODEL
// ============================================
enum NotificationType {
  HOT_LEAD
  PAYMENT_RECEIVED
  PAYMENT_FAILED
  EMAIL_REPLY
  CLIENT_TEXT
  ESCALATION
  DAILY_AUDIT
  SITE_QA_READY
  CLOSE_ENGINE
}

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  title     String
  message   String           @db.Text
  metadata  Json?            // leadId, clientId, etc.
  read      Boolean          @default(false)
  createdAt DateTime         @default(now()) @map("created_at")

  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================
// FAILED WEBHOOK MODEL (Retry queue)
// ============================================
model FailedWebhook {
  id         String   @id @default(cuid())
  source     String   // 'stripe', 'instantly', 'twilio', 'preview'
  payload    Json
  error      String?  @db.Text
  retryCount Int      @default(0) @map("retry_count")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([source])
  @@index([retryCount])
  @@map("failed_webhooks")
}

// ============================================
// API COST TRACKING MODEL
// ============================================
model ApiCost {
  id        String   @id @default(cuid())
  service   String   // 'serpapi', 'serper', 'twilio'
  operation String   // 'enrichment', 'personalization', 'sms'
  cost      Float
  createdAt DateTime @default(now()) @map("created_at")

  @@index([service])
  @@index([createdAt])
  @@map("api_costs")
}

// ============================================
// SETTINGS MODEL
// ============================================
model Settings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

// ============================================
// CLAWDBOT ACTIVITY MODEL (Audit Trail)
// ============================================
enum ClawdbotActionType {
  TEXT_SENT
  TEXT_RECEIVED
  ALERT
  HEARTBEAT
  IMPORT
  ENRICHMENT
  PERSONALIZATION
  PREVIEW_GENERATED
  NURTURE_ACTION
  URGENCY_ACTION
  UPSELL_PITCH
  REFERRAL_ASK
  ANNUAL_PITCH
  ESCALATION
  SCORE_UPDATE
  QUEUE_UPDATE
  PAYMENT_RECEIVED
  LESSON_SAVED
  PATTERN_SAVED
  ERROR
  NIGHTLY_DIGEST
  MORNING_REPORT
  WEEKLY_REPORT
}

model ClawdbotActivity {
  id          String               @id @default(cuid())
  actionType  ClawdbotActionType
  description String               @db.Text
  leadId      String?              @map("lead_id")
  clientId    String?              @map("client_id")
  repId       String?              @map("rep_id")
  metadata    Json?
  tokenCost   Float?               @map("token_cost")
  createdAt   DateTime             @default(now()) @map("created_at")

  // Relations
  lead   Lead?   @relation(fields: [leadId], references: [id], onDelete: SetNull)
  client Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)
  rep    User?   @relation(fields: [repId], references: [id], onDelete: SetNull)

  @@index([actionType])
  @@index([createdAt])
  @@index([leadId])
  @@index([clientId])
  @@map("clawdbot_activity")
}

// ============================================
// OUTBOUND EVENT MODEL (Multi-channel tracking)
// ============================================
enum OutboundChannel {
  EMAIL
  SMS
  PHONE
  LINKEDIN
  INSTANTLY
}

enum OutboundEventStatus {
  SENT
  DELIVERED
  OPENED
  CLICKED
  REPLIED
  BOUNCED
  UNSUBSCRIBED
  FAILED
}

model OutboundEvent {
  id            String              @id @default(cuid())
  leadId        String              @map("lead_id")
  channel       OutboundChannel
  status        OutboundEventStatus @default(SENT)
  messageId     String?             @map("message_id") // Instantly/provider ID
  content       String?             @db.Text
  subject       String?
  recipientEmail String?            @map("recipient_email")
  recipientPhone String?            @map("recipient_phone")
  sentAt        DateTime            @map("sent_at")
  openedAt      DateTime?           @map("opened_at")
  clickedAt     DateTime?           @map("clicked_at")
  repliedAt     DateTime?           @map("replied_at")
  metadata      Json?               // Provider-specific data
  repId         String?             @map("rep_id")
  campaignId    String?             @map("campaign_id")
  createdAt     DateTime            @default(now()) @map("created_at")

  // Relations
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  rep  User? @relation("RepOutboundEvents", fields: [repId], references: [id], onDelete: SetNull)

  @@index([leadId])
  @@index([channel])
  @@index([status])
  @@index([createdAt])
  @@index([repId])
  @@index([campaignId])
  @@map("outbound_events")
}

// ============================================
// TOUCH RECOMMENDATION MODEL (AI next-best-action)
// ============================================
enum RecommendationPriority {
  URGENT
  HIGH
  MEDIUM
  LOW
}

enum RecommendationType {
  SEND_EMAIL
  SEND_SMS
  PHONE_CALL
  LINKEDIN_MESSAGE
  FOLLOW_UP
  URGENCY_PITCH
  ANNUAL_PITCH
  UPSELL
  NURTURE
  RE_ENGAGEMENT
  ESCALATION
}

model TouchRecommendation {
  id          String                 @id @default(cuid())
  leadId      String                 @map("lead_id")
  type        RecommendationType
  priority    RecommendationPriority @default(MEDIUM)
  reason      String                 @db.Text // Why this recommendation
  suggestedAt DateTime               @map("suggested_at")
  actionTakenAt DateTime?            @map("action_taken_at")
  actionType  String?                @map("action_type") // EMAIL, SMS, etc.
  metadata    Json?                  // Hook, script, timing data
  confidence  Float?                 // 0.0 - 1.0 confidence score
  createdAt   DateTime               @default(now()) @map("created_at")

  // Relations
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([type])
  @@index([priority])
  @@index([actionTakenAt])
  @@map("touch_recommendations")
}

// ============================================
// CHANNEL PERFORMANCE MODEL (Analytics)
// ============================================
model ChannelPerformance {
  id               String   @id @default(cuid())
  channel          OutboundChannel
  campaignId       String?  @map("campaign_id")
  repId            String?  @map("rep_id")
  period           String   @db.VarChar(10) // YYYY-MM-DD
  totalSent        Int      @default(0) @map("total_sent")
  totalDelivered   Int      @default(0) @map("total_delivered")
  totalOpened      Int      @default(0) @map("total_opened")
  totalClicked     Int      @default(0) @map("total_clicked")
  totalReplied     Int      @default(0) @map("total_replied")
  totalBounced     Int      @default(0) @map("total_bounced")
  openRate         Float    @default(0) @map("open_rate") // 0.0 - 1.0
  clickRate        Float    @default(0) @map("click_rate")
  replyRate        Float    @default(0) @map("reply_rate")
  conversionCount  Int      @default(0) @map("conversion_count") // Leads → Clients
  revenue          Float    @default(0)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  rep User? @relation(fields: [repId], references: [id], onDelete: SetNull)

  @@unique([channel, campaignId, repId, period])
  @@index([channel])
  @@index([repId])
  @@index([period])
  @@map("channel_performance")
}

// ============================================
// REP TASK MODEL (Rep task management)
// ============================================
model RepTask {
  id          String    @id @default(cuid())
  leadId      String
  lead        Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  repId       String?
  rep         User?     @relation("RepTasks", fields: [repId], references: [id])
  priority    String    @default("MEDIUM")
  taskType    String    @default("INITIAL_CALL")
  status      String    @default("PENDING")
  dueAt       DateTime  @default(now())
  completedAt DateTime?
  outcome     String?
  notes       String?
  callDuration Int?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("rep_tasks")
}

// ============================================
// INSTANTLY INTEGRATION MODELS
// ============================================

model InstantlyDripLog {
  id                       String    @id @default(cuid())
  date                     DateTime  @map("date")
  campaign                 String?   // 'A' or 'B'
  totalLimit               Int       @map("total_limit") // Total inbox capacity (e.g., 750)
  usableSends              Int       @map("usable_sends") // After safety buffer (e.g., 637)
  followupObligations      Int       @map("followup_obligations") // Follow-ups due today
  availableForNew          Int       @map("available_for_new") // Capacity left for new leads
  leadsPushed              Int       @map("leads_pushed") // How many new leads actually pushed
  leadsRemainingInQueue    Int       @map("leads_remaining_in_queue") // Still waiting to push
  estDaysToClear           Int?      @map("est_days_to_clear") // Estimated days to clear queue
  createdAt                DateTime  @default(now()) @map("created_at")

  @@map("instantly_drip_log")
  @@index([date])
}

model InstantlySyncLog {
  id              String    @id @default(cuid())
  timestamp       DateTime  @map("timestamp")
  fullReport      Json?     @map("full_report") // Complete sync data
  alerts          Json?     @map("alerts") // Array of alerts
  totalCapacity   Int?      @map("total_capacity")
  totalPushed     Int?      @map("total_pushed")
  createdAt       DateTime  @default(now()) @map("created_at")

  @@map("instantly_sync_log")
  @@index([timestamp])
}

model InstantlySyncChange {
  id              String    @id @default(cuid())
  syncTimestamp   DateTime  @map("sync_timestamp")
  changeType      String    @map("change_type") // 'inbox_added', 'inbox_removed', 'inbox_limit_changed', etc.
  entity          String    // inbox email or campaign name
  fieldChanged    String?   @map("field_changed") // 'daily_limit', 'health_score', etc.
  oldValue        String?   @map("old_value")
  newValue        String?   @map("new_value")
  impact          String?   // 'capacity +21', 'inbox throttled', etc.
  createdAt       DateTime  @default(now()) @map("created_at")

  @@map("instantly_sync_changes")
  @@index([syncTimestamp])
}

// ============================================
// DIALER CALL MODEL (Power Dialer calls)
// ============================================
model Call {
  id               String    @id @default(cuid())
  leadId           String    @map("lead_id")
  repId            String    @map("rep_id")
  twilioCallSid    String?   @map("twilio_call_sid")
  conferenceSid    String?   @map("conference_sid")
  direction        String    @default("outbound")
  status           String    @default("initiated") // initiated, ringing, connected, completed, no_answer, voicemail, busy, failed
  outcome          String?   // interested, not_interested, callback, wrong_number, dnc, voicemail_left, voicemail_skipped
  durationSeconds  Int?      @map("duration_seconds")
  notes            String?   @db.Text
  callbackDate     DateTime? @map("callback_date")
  autoTexted         Boolean   @default(false) @map("auto_texted")
  previewSent        Boolean   @default(false) @map("preview_sent")
  previewOpened      Boolean   @default(false) @map("preview_opened")
  previewTimeSeconds Int?      @map("preview_time_seconds")
  paymentLinkSent    Boolean   @default(false) @map("payment_link_sent")
  paidOnCall         Boolean   @default(false) @map("paid_on_call")
  dialBatchId        String?   @map("dial_batch_id") // Groups parallel dial attempts
  lineNumber         Int?      @map("line_number") // 1, 2, or 3 in parallel dial
  createdAt          DateTime  @default(now()) @map("created_at")

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  rep  User @relation("RepCalls", fields: [repId], references: [id])

  @@index([leadId])
  @@index([repId])
  @@index([status])
  @@index([createdAt])
  @@index([dialBatchId])
  @@map("calls")
}

// ============================================
// CALL SCORING MODEL (Weekly rep performance)
// ============================================
model CallScoring {
  id                  String   @id @default(cuid())
  repId               String   @map("rep_id")
  weekStart           DateTime @map("week_start") @db.Date
  connectToInterest   Float    @default(0) @map("connect_to_interest")
  interestToClose     Float    @default(0) @map("interest_to_close")
  previewTextRate     Float    @default(0) @map("preview_text_rate") // deprecated — kept for migration compat
  previewSendRate     Float    @default(0) @map("preview_send_rate")
  previewToOpenRate   Float    @default(0) @map("preview_to_open_rate")
  openToCloseRate     Float    @default(0) @map("open_to_close_rate")
  avgDuration         Int      @default(0) @map("avg_duration")
  callbackShowRate    Float    @default(0) @map("callback_show_rate")
  dncRate             Float    @default(0) @map("dnc_rate")
  volumeScore         Int      @default(0) @map("volume_score")
  totalScore          Int      @default(0) @map("total_score")
  coachingNotes       String?  @db.Text @map("coaching_notes")
  createdAt           DateTime @default(now()) @map("created_at")

  rep User @relation("RepScoring", fields: [repId], references: [id])

  @@unique([repId, weekStart])
  @@index([repId])
  @@index([weekStart])
  @@map("call_scoring")
}

// ============================================
// DO NOT CALL MODEL
// ============================================
model DoNotCall {
  id        String   @id @default(cuid())
  phone     String   @unique
  reason    String?
  addedBy   String?  @map("added_by")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("do_not_call")
}

// ============================================
// DIALER SESSION MODEL (Track active dialing sessions)
// ============================================
model DialerSession {
  id              String    @id @default(cuid())
  repId           String    @map("rep_id")
  mode            String    @default("power") // power, single, manual
  linesPerDial    Int       @default(3) @map("lines_per_dial")
  status          String    @default("active") // active, paused, ended
  totalDials      Int       @default(0) @map("total_dials")
  totalConnects   Int       @default(0) @map("total_connects")
  totalInterested Int       @default(0) @map("total_interested")
  totalPreviews   Int       @default(0) @map("total_previews")
  startedAt       DateTime  @default(now()) @map("started_at")
  endedAt         DateTime? @map("ended_at")

  rep User @relation("DialerSessions", fields: [repId], references: [id])

  @@index([repId])
  @@index([status])
  @@map("dialer_sessions")
}

model InstantlyDailyReport {
  id                        String    @id @default(cuid())
  reportDate                DateTime  @unique @map("report_date")
  syncTimestamp             DateTime  @map("sync_timestamp")
  fullReport                String    @db.Text @map("full_report") // Complete formatted report
  smsReport                 String?   @db.Text @map("sms_report") // Condensed SMS version
  changes                   Json?     @map("changes") // Structured change data
  todayPlan                 Json?     @map("today_plan") // What's being pushed + why
  alerts                    Json?     @map("alerts") // Action items
  totalCapacity             Int?      @map("total_capacity")
  totalPushing              Int?      @map("total_pushing")
  totalFollowups            Int?      @map("total_followups")
  totalSendsExpected        Int?      @map("total_sends_expected")
  capacityUtilization       Float?    @map("capacity_utilization") // percentage
  smsSent                   Boolean   @default(false) @map("sms_sent")
  smsSentAt                 DateTime? @map("sms_sent_at")
  createdAt                 DateTime  @default(now()) @map("created_at")

  @@map("instantly_daily_reports")
  @@index([reportDate])
  @@index([createdAt])
}

// ============================================
// EDIT REQUEST MODEL (Client site edit queue)
// ============================================
model EditRequest {
  id                String    @id @default(cuid())
  clientId          String    @map("client_id")
  requestText       String    @db.Text @map("request_text")
  requestChannel    String    @default("sms") @map("request_channel") // sms, email
  aiInterpretation  String?   @db.Text @map("ai_interpretation")
  complexityTier    String    @default("medium") @map("complexity_tier") // simple, medium, complex
  stagingSnapshotUrl String?  @map("staging_snapshot_url")
  imageUrls         Json?     @map("image_urls") // Array of attached image URLs
  status            String    @default("new") @map("status") // new, ai_processing, ready_for_review, approved, rejected, live
  approvedBy        String?   @map("approved_by")
  approvedAt        DateTime? @map("approved_at")
  pushedLiveAt      DateTime? @map("pushed_live_at")
  createdAt         DateTime  @default(now()) @map("created_at")

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([status])
  @@index([createdAt])
  @@map("edit_requests")
}

// ============================================
// SEQUENCE MODEL (Automated messaging sequences)
// ============================================
model Sequence {
  id        String   @id @default(cuid())
  name      String   @unique // onboarding, upsell, anti_churn, stat_report
  steps     Json     // [{step: 1, delayDays: 0, channel: "sms", content: "...", active: true}]
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  progress SequenceProgress[]

  @@map("sequences")
}

// ============================================
// SEQUENCE PROGRESS (Per-client sequence tracking)
// ============================================
model SequenceProgress {
  id          String    @id @default(cuid())
  clientId    String    @map("client_id")
  sequenceId  String    @map("sequence_id")
  currentStep Int       @default(1) @map("current_step")
  status      String    @default("active") // active, paused, completed, cancelled
  startedAt   DateTime  @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")
  nextStepAt  DateTime? @map("next_step_at")

  client   Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  sequence Sequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  @@unique([clientId, sequenceId])
  @@index([clientId])
  @@index([sequenceId])
  @@index([status])
  @@index([nextStepAt])
  @@map("sequence_progress")
}

// ============================================
// UNIFIED PRODUCTS TABLE (Core plan + upsells in one table)
// ============================================
model UpsellProduct {
  id                  String   @id @default(cuid())
  name                String
  price               Float
  recurring           Boolean  @default(true)
  stripeLink          String?  @map("stripe_link")
  active              Boolean  @default(true)
  deletedAt           DateTime? @map("deleted_at")

  // Product type
  isCore              Boolean  @default(false) @map("is_core")  // true = core plan, false = upsell

  // Core product pricing fields (only used when isCore=true)
  month1Price         Float?   @map("month1_price")       // First month combined price (e.g., 188)
  recurringPrice      Float?   @map("recurring_price")    // Month 2+ price (e.g., 39)
  annualPrice         Float?   @map("annual_price")       // Annual option (e.g., 399)
  stripeLinkAnnual    String?  @map("stripe_link_annual") // Annual payment link

  // Copy strings (core product uses these system-wide; upsells use pitchOneLiner only)
  pitchOneLiner       String?  @map("pitch_one_liner")    // "$188 to go live, $39/mo after that"
  previewBannerText   String?  @map("preview_banner_text") // "$188 to get started"
  repCloseScript      String?  @db.Text @map("rep_close_script") // Full close script for reps

  // AI awareness fields
  description         String?  @db.Text                            // Admin reference
  aiPitchInstructions String?  @db.Text @map("ai_pitch_instructions") // How to sell this
  aiProductSummary    String?  @map("ai_product_summary")           // One-liner for AI conversation

  // Eligibility & targeting (upsells only — core products skip these checks)
  eligibleIndustries  String[] @default([]) @map("eligible_industries")
  minClientAgeDays    Int?     @map("min_client_age_days")
  maxPitchesPerClient Int      @default(3) @map("max_pitches_per_client")
  pitchChannel        String   @default("sms") @map("pitch_channel")
  sortOrder           Int      @default(0) @map("sort_order")

  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  pitches UpsellPitch[]

  @@map("upsell_products")
}

// ============================================
// UPSELL PITCH (Track upsell attempts per client)
// ============================================
model UpsellPitch {
  id             String    @id @default(cuid())
  clientId       String    @map("client_id")
  productId      String    @map("product_id")
  status         String    @default("pitched") // pitched, opened, clicked, paid, declined
  pitchedAt      DateTime  @default(now()) @map("pitched_at")
  openedAt       DateTime? @map("opened_at")
  clickedAt      DateTime? @map("clicked_at")
  paidAt         DateTime? @map("paid_at")
  pitchChannel   String    @default("sms") @map("pitch_channel")
  sequenceDay    Int?      @map("sequence_day") // Which day of upsell sequence

  product UpsellProduct @relation(fields: [productId], references: [id])

  @@index([clientId])
  @@index([productId])
  @@index([status])
  @@map("upsell_pitches")
}

// ============================================
// REFERRAL MODEL (Client referral tracking)
// ============================================
model Referral {
  id              String    @id @default(cuid())
  referrerClientId String   @map("referrer_client_id")
  referredName    String    @map("referred_name")
  referredPhone   String?   @map("referred_phone")
  referredEmail   String?   @map("referred_email")
  referredCompany String?   @map("referred_company")
  leadId          String?   @map("lead_id") // If lead was created
  status          String    @default("pending") // pending, in_pipeline, closed, no_response
  creditAmount    Float     @default(39) @map("credit_amount")
  creditApplied   Boolean   @default(false) @map("credit_applied")
  createdAt       DateTime  @default(now()) @map("created_at")

  referrerClient Client @relation("ReferrerClient", fields: [referrerClientId], references: [id], onDelete: Cascade)

  @@index([referrerClientId])
  @@index([status])
  @@map("referrals")
}

// ============================================
// SITE ANALYTICS EVENT MODEL (Self-hosted tracking)
// ============================================
model SiteAnalytic {
  id             String   @id @default(cuid())
  clientId       String   @map("client_id")
  eventType      String   @map("event_type") // pageview, cta_click, return_visit
  page           String?
  device         String?  // mobile, desktop
  referralSource String?  @map("referral_source")
  sessionId      String?  @map("session_id")
  createdAt      DateTime @default(now()) @map("created_at")

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([eventType])
  @@index([createdAt])
  @@map("site_analytics")
}

// ============================================
// STRIPE SYNC LOG (Daily reconciliation safety net)
// ============================================
model StripeSyncLog {
  id              String   @id @default(cuid())
  syncType        String   @map("sync_type") // daily_reconciliation, manual
  mismatchesFound Int      @default(0) @map("mismatches_found")
  correctionsMade Json?    @map("corrections_made") // [{clientId, field, oldValue, newValue}]
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("stripe_sync_log")
}

// ============================================
// AI PERFORMANCE LOG (Learning loop)
// ============================================
model AiPerformanceLog {
  id              String   @id @default(cuid())
  conversationId  String?  @map("conversation_id")
  messageId       String?  @map("message_id")
  aiResponseText  String?  @db.Text @map("ai_response_text")
  clientReaction  String?  @map("client_reaction") // positive, neutral, negative, escalated
  outcome         String?  // converted, resolved, escalated, churned
  editApproved    Boolean? @map("edit_approved")
  promptVersion   Int      @default(1) @map("prompt_version")
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([promptVersion])
  @@index([outcome])
  @@index([createdAt])
  @@map("ai_performance_log")
}

// ============================================
// PROMPT VERSION MODEL (AI prompt versioning)
// ============================================
model PromptVersion {
  id          String   @id @default(cuid())
  version     Int      @unique
  content     String   @db.Text // Full system prompt
  changeNotes String?  @db.Text @map("change_notes")
  performance Json?    // {conversionRate, escalationRate, approvalRate}
  active      Boolean  @default(false)
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("prompt_versions")
}

// ============================================
// CHANNEL DECISION MODEL (AI routing audit log)
// ============================================
model ChannelDecision {
  id              String   @id @default(cuid())
  clientId        String?  @map("client_id")
  leadId          String?  @map("lead_id")
  trigger         String   // 'post_launch_day_3', 'urgency_day_5', 'win_back', etc.
  chosenChannel   String   @map("chosen_channel") // SMS or EMAIL
  reason          String   // 'HARD_RULE:NO_EMAIL', 'AI:prefers_sms', 'FALLBACK:default_sms'
  ruleApplied     String?  @map("rule_applied") // Which hard rule fired, if any
  aiConfidence    Float?   @map("ai_confidence") // 0.0-1.0 from Claude
  signals         Json?    // Snapshot of signals used for decision
  latencyMs       Int?     @map("latency_ms") // How long the decision took
  messageSent     Boolean  @default(false) @map("message_sent")
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([clientId])
  @@index([leadId])
  @@index([chosenChannel])
  @@index([createdAt])
  @@map("channel_decisions")
}

// ============================================
// CLOSE ENGINE CONVERSATION (AI sales conversations)
// ============================================
model CloseEngineConversation {
  id              String    @id @default(cuid())
  leadId          String    @unique @map("lead_id")
  repId           String?   @map("rep_id")
  entryPoint      String    @map("entry_point")     // INSTANTLY_REPLY, SMS_REPLY, REP_CLOSE, PREVIEW_CTA
  stage           String    @default("INITIATED")    // INITIATED, QUALIFYING, COLLECTING_INFO, BUILDING, PREVIEW_SENT, EDIT_LOOP, PENDING_APPROVAL, PAYMENT_SENT, COMPLETED, STALLED, CLOSED_LOST
  autonomyLevel   String    @default("FULL_AUTO") @map("autonomy_level") // FULL_AUTO, SEMI_AUTO, MANUAL
  questionsAsked  Json?     @map("questions_asked")  // Array of question IDs asked so far
  collectedData   Json?     @map("collected_data")   // Structured qualification data from Claude
  editRounds      Int       @default(0) @map("edit_rounds")
  paymentLinkUrl  String?   @map("payment_link_url")
  paymentLinkSentAt DateTime? @map("payment_link_sent_at")
  stalledAt       DateTime? @map("stalled_at")
  completedAt     DateTime? @map("completed_at")
  closedLostAt    DateTime? @map("closed_lost_at")
  closedLostReason String?  @map("closed_lost_reason")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  lead           Lead            @relation(fields: [leadId], references: [id], onDelete: Cascade)
  rep            User?           @relation("CloseEngineRep", fields: [repId], references: [id])
  pendingActions PendingAction[]

  @@index([stage])
  @@index([entryPoint])
  @@index([createdAt])
  @@map("close_engine_conversations")
}

// ============================================
// PENDING ACTION (Approval queue for Semi-Auto/Manual)
// ============================================
model PendingAction {
  id              String    @id @default(cuid())
  conversationId  String    @map("conversation_id")
  leadId          String    @map("lead_id")
  type            String    // SEND_PAYMENT_LINK, SEND_MESSAGE, SEND_PREVIEW
  draftMessage    String    @db.Text @map("draft_message")
  metadata        Json?     // paymentUrl, previewUrl, etc.
  status          String    @default("PENDING") // PENDING, APPROVED, REJECTED, EXPIRED
  approvedBy      String?   @map("approved_by")
  approvedAt      DateTime? @map("approved_at")
  expiresAt       DateTime? @map("expires_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  conversation CloseEngineConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  lead         Lead                     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([leadId])
  @@index([conversationId])
  @@map("pending_actions")
}
